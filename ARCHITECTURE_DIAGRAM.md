# Secure API Key System Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USER INTERFACE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              APIKeySettingsView                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  SecureField: Enter API Key                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Button: [ğŸ‘ï¸] Show/Hide                           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Button: [ğŸ’¾] Save                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  Button: [ğŸ—‘ï¸] Delete (if configured)             â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Toggle: Enable External AI                                  â”‚   â”‚
â”‚  â”‚  TextField: API Endpoint URL                                 â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  âš ï¸ Security Notice: Auto-deleted on app quit               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SECURITY LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          SecureAPIKeyManager (@MainActor)                    â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  @Published isAPIKeyConfigured: Bool                         â”‚   â”‚
â”‚  â”‚  @Published lastError: String?                               â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Methods:                                                     â”‚   â”‚
â”‚  â”‚  â€¢ saveAPIKey(String) throws                                 â”‚   â”‚
â”‚  â”‚  â€¢ retrieveAPIKey() throws -> String                         â”‚   â”‚
â”‚  â”‚  â€¢ deleteAPIKey() throws                                     â”‚   â”‚
â”‚  â”‚  â€¢ hasAPIKey() -> Bool                                       â”‚   â”‚
â”‚  â”‚  â€¢ validateAPIKey() -> Bool                                  â”‚   â”‚
â”‚  â”‚  â€¢ cleanupSession()                                          â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Cleanup Observers:                                          â”‚   â”‚
â”‚  â”‚  â€¢ NSApplicationWillTerminateNotification                    â”‚   â”‚
â”‚  â”‚  â€¢ deinit                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STORAGE LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              iOS/macOS Keychain Services                     â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Service: com.appolforgesym.aiagent                         â”‚   â”‚
â”‚  â”‚  Account: external-ai-api-key                               â”‚   â”‚
â”‚  â”‚  Access: kSecAttrAccessibleWhenUnlockedThisDeviceOnly       â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Security Features:                                          â”‚   â”‚
â”‚  â”‚  âœ“ Hardware encryption                                      â”‚   â”‚
â”‚  â”‚  âœ“ Device-only (no iCloud sync)                            â”‚   â”‚
â”‚  â”‚  âœ“ Requires device unlock                                   â”‚   â”‚
â”‚  â”‚  âœ“ Isolated from app sandbox                               â”‚   â”‚
â”‚  â”‚  âœ“ Protected by OS security                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTEGRATION LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        ExternalAIAgentService (@MainActor)                   â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  @Published isEnabled: Bool                                  â”‚   â”‚
â”‚  â”‚  @Published lastResponse: AIAgentResponse?                   â”‚   â”‚
â”‚  â”‚  @Published isLoading: Bool                                  â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  async getRecommendations(                                   â”‚   â”‚
â”‚  â”‚      gameState: GameState,                                   â”‚   â”‚
â”‚  â”‚      playerType: PlayerType,                                 â”‚   â”‚
â”‚  â”‚      apiEndpoint: URL                                        â”‚   â”‚
â”‚  â”‚  ) throws -> AIAgentResponse                                 â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Uses SecureAPIKeyManager to retrieve key                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXTERNAL APIs                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚    OpenAI      â”‚  â”‚   Anthropic    â”‚  â”‚  Custom API    â”‚       â”‚
â”‚  â”‚   GPT-4/3.5    â”‚  â”‚     Claude     â”‚  â”‚                â”‚       â”‚
â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                â”‚       â”‚
â”‚  â”‚  Bearer Token  â”‚  â”‚  x-api-key     â”‚  â”‚  Custom Auth   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagrams

### 1. Saving API Key

```
User enters key    SecureAPIKeyManager    Keychain
     â”‚                      â”‚                â”‚
     â”‚â”€â”€saveAPIKey()â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
     â”‚                      â”‚                â”‚
     â”‚                      â”‚â”€â”€validate()â”€â”€â”€â”€â”‚
     â”‚                      â”‚                â”‚
     â”‚                      â”‚â”€â”€SecItemAdd()â†’â”‚
     â”‚                      â”‚                â”‚
     â”‚                      â”‚â†â”€â”€successâ”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                â”‚
     â”‚                      â”‚â”€â”€publish()â”€â”€â”€â”€â”€â”‚
     â”‚â†â”€â”€successâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                      â”‚                â”‚
     â”‚  [Show confirmation]                  â”‚
```

### 2. Making API Call

```
Game Logic    ExternalAIAgent    SecureAPIKeyManager    Keychain    External API
     â”‚               â”‚                   â”‚                  â”‚             â”‚
     â”‚â”€â”€request()â”€â”€â”€â†’â”‚                   â”‚                  â”‚             â”‚
     â”‚               â”‚                   â”‚                  â”‚             â”‚
     â”‚               â”‚â”€â”€retrieveKey()â”€â”€â”€â†’â”‚                  â”‚             â”‚
     â”‚               â”‚                   â”‚â”€â”€SecItemCopy()â”€â”€â†’â”‚             â”‚
     â”‚               â”‚                   â”‚â†â”€â”€keyâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
     â”‚               â”‚â†â”€â”€keyâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚             â”‚
     â”‚               â”‚                                      â”‚             â”‚
     â”‚               â”‚â”€â”€POST w/ Bearer tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚               â”‚                                      â”‚             â”‚
     â”‚               â”‚â†â”€â”€AI responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚               â”‚                                      â”‚             â”‚
     â”‚â†â”€â”€resultâ”€â”€â”€â”€â”€â”€â”‚                                      â”‚             â”‚
```

### 3. Session Cleanup

```
User quits    NSNotification    PersistenceManager    SecureAPIKeyManager    Keychain
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚â”€â”€Cmd+Qâ”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                  â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚                â”‚â”€â”€post()â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚â”€â”€cleanupSession()â”€â”€â”€â†’â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚â”€â”€SecItemDelete()â†’â”‚
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚â†â”€â”€successâ”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚â”€â”€deinit cleanupâ”€â”‚
     â”‚                â”‚                  â”‚â†â”€â”€doneâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚â†â”€â”€doneâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                â”‚
     â”‚                â”‚                  â”‚                      â”‚                â”‚
     â”‚  [App terminates safely]                                                  â”‚
```

## Component Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AppSettings                            â”‚
â”‚  â€¢ externalAIEnabled: Bool                                 â”‚
â”‚  â€¢ externalAIEndpoint: String                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ ObservedObject
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  APIKeySettingsView                         â”‚
â”‚  â€¢ UI for API key management                               â”‚
â”‚  â€¢ Security notices                                        â”‚
â”‚  â€¢ Endpoint configuration                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ StateObject
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SecureAPIKeyManager (Singleton)               â”‚
â”‚  â€¢ Keychain operations                                     â”‚
â”‚  â€¢ Cleanup coordination                                    â”‚
â”‚  â€¢ Observable properties                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Used by
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ExternalAIAgentService (Singleton)               â”‚
â”‚  â€¢ Network requests                                        â”‚
â”‚  â€¢ Response parsing                                        â”‚
â”‚  â€¢ Game state serialization                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Used by
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   StrategicAdvisor                          â”‚
â”‚  â€¢ Game logic recommendations                              â”‚
â”‚  â€¢ AI recommendations (optional)                           â”‚
â”‚  â€¢ Combined strategy                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Boundaries                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: User Input Validation
   â†“
   â€¢ SecureField for password-like entry
   â€¢ Show/hide toggle for verification
   â€¢ Empty key rejection
   â€¢ Minimum length validation
   
Layer 2: Application Security
   â†“
   â€¢ MainActor isolation (thread-safe)
   â€¢ Published properties for SwiftUI
   â€¢ Error handling with typed errors
   â€¢ No logging of sensitive data
   
Layer 3: Keychain Security
   â†“
   â€¢ kSecAttrAccessibleWhenUnlockedThisDeviceOnly
   â€¢ Device-only storage (no iCloud sync)
   â€¢ OS-level encryption
   â€¢ Isolated from app sandbox
   
Layer 4: Network Security
   â†“
   â€¢ HTTPS only
   â€¢ Bearer token authorization
   â€¢ No key in URL/query params
   â€¢ Request/response validation
   
Layer 5: Lifecycle Security
   â†“
   â€¢ Auto-delete on app termination
   â€¢ Triple cleanup protection
   â€¢ Session-based architecture
   â€¢ No persistent storage
```

## State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Not         â”‚
â”‚ Configured  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ User enters & saves key
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configured  â”‚â†â”€â”€â”€â”€â”
â”‚ (In Session)â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
       â”‚            â”‚
       â”‚            â”‚ User re-enters key
       â”‚            â”‚ (new session)
       â†“            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ Cleaned Up  â”‚     â”‚
â”‚ (App Quit)  â”‚â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘
       â”‚
       â”‚ Manual delete or app termination
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configured  â”‚
â”‚ (In Session)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

States:
â€¢ Not Configured: No key in Keychain, AI features disabled
â€¢ Configured: Key in Keychain, AI features available
â€¢ Cleaned Up: Key removed from Keychain, must re-enter

Transitions:
â€¢ Configure: Not Configured â†’ Configured
â€¢ Cleanup: Configured â†’ Cleaned Up (automatic)
â€¢ Delete: Configured â†’ Not Configured (manual)
â€¢ Re-enter: Cleaned Up â†’ Configured (user action)
```

## Error Flow

```
Operation Attempt
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Try Block  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â†’ Success
       â”‚         â†“
       â”‚    Return value/success
       â”‚
       â””â”€â”€â†’ Failure
                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Catch Block  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€â”€â†’ APIKeyError.emptyKey
                â”‚         â†“
                â”‚    "API key cannot be empty"
                â”‚
                â”œâ”€â”€â†’ APIKeyError.keyNotFound
                â”‚         â†“
                â”‚    "No API key found"
                â”‚
                â”œâ”€â”€â†’ APIKeyError.keychainError(status)
                â”‚         â†“
                â”‚    "Keychain error: [code]"
                â”‚
                â””â”€â”€â†’ Other error
                          â†“
                     Generic error message

All errors:
â€¢ Localized for user display
â€¢ Logged (without sensitive data)
â€¢ Published to lastError property
â€¢ Handled gracefully (no crashes)
```

---

This architecture ensures:
âœ… Maximum security (Keychain, encryption, device-only)
âœ… Automatic cleanup (triple protection)
âœ… User-friendly (clear UI, error messages)
âœ… Observable (SwiftUI integration)
âœ… Testable (mock data, DEBUG tools)
âœ… Maintainable (clear separation of concerns)
